apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    app: prometheus-operator
    release: prometheus-operator
  name: gitlab-token-detailed-alerts
  namespace: monitoring
spec:
  groups:
  - name: gitlab-tokens-detailed
    rules:
    # Алерты для токенов с истечением через 1 месяц (720 часов)
    - alert: TokenExpiresInOneMonth
      expr: gitlab_token_expires_at < 720 and gitlab_token_expires_at >= 336
      for: 10m
      labels:
        severity: info
      annotations:
        summary: "GitLab токен истекает через месяц"
        description: "Токен {{ $labels.name }} истекает через {{ $value }} часов (примерно месяц)"

    - alert: UserTokenExpiresInOneMonth
      expr: gitlab_user_token_expires_at < 720 and gitlab_user_token_expires_at >= 336
      for: 10m
      labels:
        severity: info
      annotations:
        summary: "Пользовательский GitLab токен истекает через месяц"
        description: "Пользовательский токен {{ $labels.name }} истекает через {{ $value }} часов (примерно месяц)"

    # Алерты для токенов с истечением через 3 дня (72 часа)
    - alert: TokenExpiresInThreeDays
      expr: gitlab_token_expires_at < 72 and gitlab_token_expires_at >= 24
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "GitLab токен истекает через 3 дня"
        description: "Токен {{ $labels.name }} истекает через {{ $value }} часов (менее 3 дней)"

    - alert: UserTokenExpiresInThreeDays
      expr: gitlab_user_token_expires_at < 72 and gitlab_user_token_expires_at >= 24
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Пользовательский GitLab токен истекает через 3 дня"
        description: "Пользовательский токен {{ $labels.name }} истекает через {{ $value }} часов (менее 3 дней)"

    # Алерты для токенов с истечением через 1 день (24 часа)
    - alert: TokenExpiresInOneDay
      expr: gitlab_token_expires_at < 24 and gitlab_token_expires_at >= 1
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "GitLab токен истекает через день"
        description: "Токен {{ $labels.name }} истекает через {{ $value }} часов (менее дня)"

    - alert: UserTokenExpiresInOneDay
      expr: gitlab_user_token_expires_at < 24 and gitlab_user_token_expires_at >= 1
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Пользовательский GitLab токен истекает через день"
        description: "Пользовательский токен {{ $labels.name }} истекает через {{ $value }} часов (менее дня)"

    # Алерты для токенов с истечением через 1 час
    - alert: TokenExpiresInOneHour
      expr: gitlab_token_expires_at < 1 and gitlab_token_expires_at > 0
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "GitLab токен истекает через час"
        description: "Токен {{ $labels.name }} истекает через {{ $value }} часов (менее часа)"

    - alert: UserTokenExpiresInOneHour
      expr: gitlab_user_token_expires_at < 1 and gitlab_user_token_expires_at > 0
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "Пользовательский GitLab токен истекает через час"
        description: "Пользовательский токен {{ $labels.name }} истекает через {{ $value }} часов (менее часа)"

    # Алерт на отсутствие метрик токенов
    - alert: NoTokenMetrics
      expr: gitlab_tokens_total == 0
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Отсутствуют метрики токенов GitLab"
        description: "Не обнаружено активных токенов GitLab в метриках"

    - alert: NoUserTokenMetrics
      expr: gitlab_user_tokens_total == 0
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Отсутствуют метрики пользовательских токенов GitLab"
        description: "Не обнаружено активных пользовательских токенов GitLab в метриках"
